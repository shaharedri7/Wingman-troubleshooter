<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wingman Troubleshooter</title>
  <style>
    :root {
      --bg-main: #1c1c1c;
      --bg-secondary: #2c3e50;
      --text-color: #ffffff;
      --question-bg: #ecf0f1;
      --question-text: #2c3e50;
    }

    body.light {
      --bg-main: #ffffff;
      --bg-secondary: #f0f0f0;
      --text-color: #2c3e50;
      --question-bg: #ffffff;
      --question-text: #000000;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, var(--bg-main), var(--bg-secondary));
      color: var(--text-color);
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    h1 {
      text-align: center;
      color: #00d8ff;
      font-size: 3em;
      margin-bottom: 10px;
    }

    .section-title {
      background-color: #34495e;
      padding: 10px 15px;
      border-left: 6px solid #00d8ff;
      border-radius: 4px;
      margin: 30px auto 10px;
      max-width: 800px;
      font-size: 1.2em;
      font-weight: bold;
    }

    .question {
      background-color: var(--question-bg);
      color: var(--question-text);
      margin: 10px auto;
      padding: 20px;
      border-left: 6px solid #007bff;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      max-width: 800px;
    }

    .progress {
      font-weight: bold;
      font-size: 1em;
      margin-bottom: 10px;
    }

    button {
      margin: 5px 10px 0 0;
      padding: 10px 16px;
      font-weight: bold;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }

    button:hover {
      background-color: #0056b3;
    }

    #result {
      background-color: #ffa500;
      padding: 20px;
      margin-top: 40px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      border-left: 6px solid #ff7300;
      font-weight: bold;
      border-radius: 6px;
      color: #2c3e50;
    }

    #suggestionPanel {
      background-color: #f1c40f;
      color: #2c3e50;
      position: fixed;
      top: 100px;
      right: 20px;
      width: 300px;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.25);
      border-radius: 6px;
    }

    .suggestion-item {
      margin-bottom: 10px;
      border-bottom: 1px solid #f39c12;
      padding-bottom: 5px;
    }

    .hidden {
      display: none;
    }

    .thumbnail {
      display: block;
      width: 400px;
      height: 300px;
      margin-top: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    #controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Wingman Troubleshooter</h1>
  <div id="controls">
    <button id="restartBtn" onclick="restartWorkflow()">Restart</button>
    <button onclick="toggleMode()">ðŸŒ— Toggle Theme</button>
  </div>
  <div id="workflow"></div>
  <div id="result" class="hidden">
    <p><strong>Final Note:</strong> If the issue persists after completing this checklist, please escalate via <strong>TOP GUN</strong> for further investigation.</p>
  </div>
  <div id="suggestionPanel" class="hidden">
    <h3>Suggestions</h3>
    <div id="suggestionList"></div>
  </div>

  <script>
    let questions = [];
    fetch("flow.json")
      .then(res => res.json())
      .then(data => {
        questions = data;
        startWorkflow();
      });

    const workflowContainer = document.getElementById("workflow");
    const resultContainer = document.getElementById("result");
    const suggestionPanel = document.getElementById("suggestionPanel");
    const suggestionList = document.getElementById("suggestionList");
    let shownSuggestions = new Set();
    let answeredQuestions = new Set();

    function startWorkflow() {
      questions.forEach((q, index) => {
        const qDiv = document.createElement("div");
        qDiv.className = "question hidden";
        qDiv.id = q.id;

        const progress = document.createElement("div");
        progress.className = "progress";
        progress.textContent = `Step ${index + 1} of ${questions.length}`;
        qDiv.appendChild(progress);

        const p = document.createElement("p");
        p.innerHTML = q.text;
        qDiv.appendChild(p);

        if (q.images && Array.isArray(q.images)) {
          q.images.forEach((src) => {
            const img = document.createElement("img");
            img.src = src;
            img.alt = "Reference image";
            img.className = "thumbnail";
            qDiv.appendChild(img);
          });
        } else if (q.image) {
          const img = document.createElement("img");
          img.src = q.image;
          img.alt = "Reference image";
          img.className = "thumbnail";
          qDiv.appendChild(img);
        }

        q.answers.forEach((ans) => {
          const btn = document.createElement("button");
          btn.textContent = ans.text;
          btn.onclick = () => handleAnswer(q.id, ans);
          qDiv.appendChild(btn);
        });

        workflowContainer.appendChild(qDiv);
      });

      showQuestion(questions[0].id);
    }

    function handleAnswer(currentId, answer) {
      const currentIndex = questions.findIndex(q => q.id === currentId);
      if (answer.suggestion && !shownSuggestions.has(currentId)) {
        shownSuggestions.add(currentId);

        const sItem = document.createElement("div");
        sItem.className = "suggestion-item";
        sItem.textContent = answer.suggestion;
        suggestionList.appendChild(sItem);
        suggestionPanel.classList.remove("hidden");

        const retryBtnId = `${currentId}-retry`;
        const currentQuestionDiv = document.getElementById(currentId);
        const buttons = currentQuestionDiv.querySelectorAll("button");
        buttons.forEach(btn => {
          if (!btn.id.endsWith("-retry")) {
            btn.disabled = true;
            btn.style.opacity = "0.5";
            btn.style.cursor = "not-allowed";
          }
        });

        if (!document.getElementById(retryBtnId)) {
          const retryBtn = document.createElement("button");
          retryBtn.id = retryBtnId;
          retryBtn.textContent = "Try Again";
          retryBtn.style.backgroundColor = "#ffa500";
          retryBtn.style.marginTop = "10px";
          retryBtn.onclick = () => {
  hideQuestion(currentId);
  showQuestion(currentId);

  const qDiv = document.getElementById(currentId);
  const allBtns = qDiv.querySelectorAll("button");
  allBtns.forEach(btn => {
    btn.disabled = false;
    btn.style.opacity = "1";
    btn.style.cursor = "pointer";
  });

  // Remove the suggestion item for this question
  const allSuggestions = suggestionList.querySelectorAll(".suggestion-item");
  allSuggestions.forEach((item) => {
    if (item.textContent === answer.suggestion) {
      item.remove();
    }
  });

  // Hide suggestion panel if it's now empty
  if (suggestionList.children.length === 0) {
    suggestionPanel.classList.add("hidden");
  }

  retryBtn.remove();
};
          currentQuestionDiv.appendChild(retryBtn);
        }

        if (!(currentId === "q18" && answer.text === "Yes")) {
          return;
        }
      }

      answeredQuestions.add(currentId);

      if (
        currentId === "q18" &&
        (answer.text === "No" || answer.text === "N/A")
      ) {
        resultContainer.classList.remove("hidden");
        resultContainer.scrollIntoView({ behavior: "smooth" });

        const lastQDiv = document.getElementById(currentId);
        const buttons = lastQDiv.querySelectorAll("button");
        buttons.forEach(btn => btn.remove());

        const doneMsg = document.createElement("p");
        doneMsg.textContent = "âœ… Workflow is complete. All steps reviewed.";
        doneMsg.style.color = "#ffa500";
        doneMsg.style.fontWeight = "bold";
        doneMsg.style.marginTop = "20px";
        lastQDiv.appendChild(doneMsg);
      }

      if (answer.stop && currentId !== "q18") return;

      if (answer.next) {
        hideQuestion(currentId);
        showQuestion(answer.next);
      }
    }

    function showQuestion(id) {
      const question = document.getElementById(id);
      if (question) question.classList.remove("hidden");
    }

    function hideQuestion(id) {
      const question = document.getElementById(id);
      if (question) question.classList.add("hidden");
    }

    function restartWorkflow() {
      questions.forEach((q) => hideQuestion(q.id));
      document.querySelectorAll("button[id$='-retry']").forEach(btn => btn.remove());
      suggestionList.innerHTML = "";
      suggestionPanel.classList.add("hidden");
      resultContainer.classList.add("hidden");
      shownSuggestions.clear();
      answeredQuestions.clear();
      showQuestion(questions[0].id);
    }

    function toggleMode() {
      document.body.classList.toggle("light");
    }
  </script>
</body>
</html>
